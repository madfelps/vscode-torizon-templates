{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "build-debug-x86",
      "command": "go",
      "type": "shell",
      "args": ["build", "${workspaceFolder}/src/main.go"],
      "problemMatcher": [
        {
          "owner": "go run",
          "fileLocation": ["relative", "${workspaceRoot}"],
          "pattern": {
            "regexp": "^(.*):(\\d+):(\\d+):\\s+(\\d+):(\\d+)\\s+(warning|error):\\s+(.*)$",
            "file": 1,
            "line": 2,
            "column": 3,
            "endLine": 4,
            "endColumn": 5,
            "severity": 6,
            "message": 7
          }
        }
      ],
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      },
      "dependsOrder": "sequence"
    },
    {
      "label": "build-container-image-sdk-arm64",
      "command": "docker",
      "type": "shell",
      "args": [
        "build",
        "-f",
        "${workspaceFolder}/Dockerfile.sdk",
        "${workspaceFolder}",
        "-t",
        "cross-toolchain-arm64-__container__"
      ],
      "problemMatcher": [
        {
          "owner": "rust",
          "fileLocation": ["relative", "${workspaceRoot}"],
          "pattern": {
            "regexp": "^(.*):(\\d+):(\\d+):\\s+(\\d+):(\\d+)\\s+(warning|error):\\s+(.*)$",
            "file": 1,
            "line": 2,
            "column": 3,
            "endLine": 4,
            "endColumn": 5,
            "severity": 6,
            "message": 7
          }
        }
      ],
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "build-debug-arm64_t",
      "command": "docker",
      "type": "shell",
      "args": [
        "run",
        "--rm",
        "-it",
        "-v",
        "${workspaceFolder}:/app",
        "cross-toolchain-arm64-__container__",
        "cargo",
        "build",
        "--target",
        "aarch64-unknown-linux-gnu"
      ],
      "problemMatcher": [
        {
          "owner": "rust",
          "fileLocation": ["relative", "${workspaceRoot}"],
          "pattern": {
            "regexp": "^(.*):(\\d+):(\\d+):\\s+(\\d+):(\\d+)\\s+(warning|error):\\s+(.*)$",
            "file": 1,
            "line": 2,
            "column": 3,
            "endLine": 4,
            "endColumn": 5,
            "severity": 6,
            "message": 7
          }
        }
      ],
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      },
      "dependsOrder": "sequence",
      "dependsOn": ["build-container-image-sdk-arm64"]
    },
    {
      "label": "build-debug-arm64",
      "command": "env",
      "type": "shell",
      "args": [
        "CGO_ENABLED=0",
        "GOOS=linux",
        "GOARCH=arm64",
        "go",
        "build",
        "-gcflags",
        "\"all=-N",
        "-l\"",
        "./src/main.go"
      ],
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      },
      "dependsOrder": "sequence"
    },
    {
      "label": "pre-cleanup-arm64",
      "detail": "hide",
      "command": "sshpass",
      "type": "process",
      "args": [
        "-p",
        "${config:torizon_psswd}",
        "ssh",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "torizon@${config:torizon_ip}",
        "LOCAL_REGISTRY=${config:host_ip} TAG=arm64 docker-compose down --remove-orphans"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "build-container-torizon-debug-arm64_t",
      "detail": "hide",
      "command": "docker-compose",
      "type": "process",
      "options": {
        "env": {
          "LOCAL_REGISTRY": "localhost",
          "TAG": "arm64"
        }
      },
      "args": [
        "build",
        "--build-arg",
        "IMAGE_ARCH=arm64",
        "__container__-debug"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "build-container-torizon-debug-arm64",
      "detail": "hide",
      "command": "docker-compose",
      "type": "process",
      "options": {
        "env": {
          "LOCAL_REGISTRY": "localhost",
          "TAG": "arm64"
        }
      },
      "args": [
        "build",
        "--build-arg",
        "IMAGE_ARCH=arm64",
        "__container__-debug"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "push-container-torizon-debug-arm64",
      "detail": "hide",
      "command": "docker-compose",
      "type": "process",
      "options": {
        "env": {
          "LOCAL_REGISTRY": "localhost",
          "TAG": "arm64"
        }
      },
      "args": ["push", "__container__-debug"],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "pull-container-torizon-debug-arm64",
      "detail": "hide",
      "command": "sshpass",
      "type": "process",
      "args": [
        "-p",
        "${config:torizon_psswd}",
        "ssh",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "torizon@${config:torizon_ip}",
        "LOCAL_REGISTRY=${config:host_ip} TAG=arm64 docker-compose pull __container__-debug"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "run-container-torizon-debug-arm64",
      "detail": "hide",
      "command": "sshpass",
      "type": "process",
      "args": [
        "-p",
        "${config:torizon_psswd}",
        "ssh",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "torizon@${config:torizon_ip}",
        "LOCAL_REGISTRY=${config:host_ip} TAG=arm64 docker-compose up -d __container__-debug"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "deploy-torizon-arm64",
      "detail": "hide",
      "command": "scp",
      "type": "process",
      "args": [
        "-i",
        "${workspaceFolder}/.conf/id_rsa",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "-P",
        "${config:torizon_debug_ssh_port}",
        "-pr",
        "${workspaceFolder}/target/aarch64-unknown-linux-gnu/debug",
        "torizon@${config:torizon_ip}:~/app"
      ],
      "dependsOn": [
        "copy-docker-compose",
        "pre-cleanup-arm64",
        "build-debug-arm64",
        "build-container-torizon-debug-arm64",
        "push-container-torizon-debug-arm64",
        "pull-container-torizon-debug-arm64",
        "run-container-torizon-debug-arm64"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "build-container-image-sdk-arm",
      "command": "docker",
      "type": "shell",
      "args": [
        "build",
        "-f",
        "${workspaceFolder}/Dockerfile.sdk",
        "${workspaceFolder}",
        "-t",
        "cross-toolchain-arm-__container__"
      ],
      "problemMatcher": [
        {
          "owner": "rust",
          "fileLocation": ["relative", "${workspaceRoot}"],
          "pattern": {
            "regexp": "^(.*):(\\d+):(\\d+):\\s+(\\d+):(\\d+)\\s+(warning|error):\\s+(.*)$",
            "file": 1,
            "line": 2,
            "column": 3,
            "endLine": 4,
            "endColumn": 5,
            "severity": 6,
            "message": 7
          }
        }
      ],
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "build-debug-arm",
      "command": "env",
      "type": "shell",
      "args": [
        "CGO_ENABLED=0",
        "GOOS=linux",
        "GOARCH=arm",
        "go",
        "build",
        "-gcflags",
        "\"all=-N",
        "-l\"",
        "./src/main.go"
      ],
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      },
      "dependsOrder": "sequence"
    },
    {
      "label": "pre-cleanup-arm",
      "detail": "hide",
      "command": "sshpass",
      "type": "process",
      "args": [
        "-p",
        "${config:torizon_psswd}",
        "ssh",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "torizon@${config:torizon_ip}",
        "LOCAL_REGISTRY=${config:host_ip} TAG=arm docker-compose down --remove-orphans"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "build-container-torizon-debug-arm",
      "detail": "hide",
      "command": "docker-compose",
      "type": "process",
      "options": {
        "env": {
          "LOCAL_REGISTRY": "localhost",
          "TAG": "arm"
        }
      },
      "args": ["build", "--build-arg", "IMAGE_ARCH=arm", "__container__-debug"],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "push-container-torizon-debug-arm",
      "detail": "hide",
      "command": "docker-compose",
      "type": "process",
      "options": {
        "env": {
          "LOCAL_REGISTRY": "localhost",
          "TAG": "arm"
        }
      },
      "args": ["push", "__container__-debug"],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "pull-container-torizon-debug-arm",
      "detail": "hide",
      "command": "sshpass",
      "type": "process",
      "args": [
        "-p",
        "${config:torizon_psswd}",
        "ssh",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "torizon@${config:torizon_ip}",
        "LOCAL_REGISTRY=${config:host_ip} TAG=arm docker-compose pull __container__-debug"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "run-container-torizon-debug-arm",
      "detail": "hide",
      "command": "sshpass",
      "type": "process",
      "args": [
        "-p",
        "${config:torizon_psswd}",
        "ssh",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "torizon@${config:torizon_ip}",
        "LOCAL_REGISTRY=${config:host_ip} TAG=arm docker-compose up -d __container__-debug"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "deploy-torizon-arm",
      "detail": "hide",
      "command": "scp",
      "type": "process",
      "args": [
        "-i",
        "${workspaceFolder}/.conf/id_rsa",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "-P",
        "${config:torizon_debug_ssh_port}",
        "-pr",
        "${workspaceFolder}/target/armv7-unknown-linux-gnueabihf/debug",
        "torizon@${config:torizon_ip}:~/app"
      ],
      "dependsOn": [
        "copy-docker-compose",
        "pre-cleanup-arm",
        "build-debug-arm",
        "build-container-torizon-debug-arm",
        "push-container-torizon-debug-arm",
        "pull-container-torizon-debug-arm",
        "run-container-torizon-debug-arm"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "wait-debugpy-start-arm",
      "detail": "hide",
      "command": "sleep",
      "type": "process",
      "args": ["2"],
      "dependsOn": [
        "validate-settings",
        "validate-arch-arm",
        "apply-torizon-packages",
        "copy-docker-compose",
        "pre-cleanup-arm",
        "build-debug-arm",
        "build-container-torizon-debug-arm",
        "push-container-torizon-debug-arm",
        "pull-container-torizon-debug-arm",
        "run-container-torizon-debug-arm",
        "wait-a-bit",
        "pos-cleanup",
        "deploy-torizon-arm",
        "start-torizon-debug-arm"
      ],
      "dependsOrder": "sequence",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "Create Production Docker Image",
      "command": "echo",
      "type": "process",
      "presentation": {
        "echo": false,
        "reveal": "always",
        "focus": true,
        "panel": "shared",
        "showReuseMessage": true,
        "clear": false
      },
      "args": ["✅ Successfully Finished"],
      "dependsOrder": "sequence",
      "dependsOn": ["create-production-image"],
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "create-production-image",
      "detail": "hide",
      "command": "pwsh",
      "type": "process",
      "presentation": {
        "echo": false,
        "reveal": "always",
        "focus": true,
        "panel": "shared",
        "showReuseMessage": true,
        "clear": false
      },
      "args": [
        "${workspaceFolder}/.conf/createDockerComposeProduction.ps1",
        "${workspaceFolder}",
        "${command:docker_registry}",
        "${input:dockerImageTag}",
        "__container__",
        "${input:archList}",
        "${command:docker_password}"
      ],
      "dependsOrder": "sequence",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "docker-login",
      "command": "docker",
      "type": "process",
      "options": {
        "env": {
          "DOCKER_LOGIN": "${command:docker_login}",
          "DOCKER_PSSWD": "${command:docker_password}"
        }
      },
      "args": [
        "login",
        "--username",
        "${command:docker_login}",
        "--password",
        "${command:docker_password}"
      ],
      "dependsOrder": "sequence",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "run-docker-registry",
      "command": "pwsh",
      "type": "process",
      "presentation": {
        "echo": false,
        "reveal": "silent",
        "focus": false,
        "panel": "shared",
        "showReuseMessage": true,
        "clear": false
      },
      "args": [
        "${workspaceFolder}/.conf/runContainerIfNotExists.ps1",
        "docker",
        "'-d -p 5002:5002 --restart=always registry:2'",
        "registry"
      ],
      "dependsOrder": "sequence",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "run-torizon-binfmt",
      "command": "pwsh",
      "type": "process",
      "presentation": {
        "echo": false,
        "reveal": "silent",
        "focus": false,
        "panel": "shared",
        "showReuseMessage": true,
        "clear": false
      },
      "args": [
        "${workspaceFolder}/.conf/runContainerIfNotExists.ps1",
        "docker",
        "'--rm -it --privileged torizon/binfmt'",
        "binfmt"
      ],
      "dependsOrder": "sequence",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "run-share-wsl-ports",
      "command": "pwsh",
      "type": "process",
      "presentation": {
        "echo": false,
        "reveal": "silent",
        "focus": false,
        "panel": "shared",
        "showReuseMessage": true,
        "clear": false
      },
      "args": ["${workspaceFolder}/.conf/shareWSLPorts.ps1"],
      "dependsOrder": "sequence",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "check-deps",
      "command": "pwsh",
      "type": "process",
      "presentation": {
        "echo": false,
        "reveal": "always",
        "focus": true,
        "panel": "dedicated",
        "showReuseMessage": true,
        "clear": false
      },
      "args": ["${workspaceFolder}/.conf/checkDeps.ps1"],
      "dependsOrder": "sequence",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "apply-torizon-packages",
      "command": "pwsh",
      "type": "process",
      "presentation": {
        "echo": false,
        "reveal": "always",
        "focus": true,
        "panel": "dedicated",
        "showReuseMessage": true,
        "clear": false
      },
      "args": [
        "${workspaceFolder}/.conf/torizonPackages.ps1",
        "${config:torizon_arch}"
      ],
      "dependsOrder": "sequence",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "copy-docker-compose",
      "command": "sshpass",
      "type": "process",
      "args": [
        "-p",
        "${config:torizon_psswd}",
        "scp",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "${config:torizon_workspace}/docker-compose.yml",
        "torizon@${config:torizon_ip}:~/"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "wait-a-bit",
      "detail": "hide",
      "command": "sleep",
      "type": "process",
      "args": ["1"],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "pos-cleanup",
      "detail": "hide",
      "command": "ssh",
      "type": "process",
      "args": [
        "-i",
        "${workspaceFolder}/.conf/id_rsa",
        "-p",
        "${config:torizon_debug_ssh_port}",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "torizon@${config:torizon_ip}",
        "rm -rf ~/app"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "validate-settings",
      "detail": "hide",
      "command": "bash",
      "type": "process",
      "args": ["-c", "[[ ! -z \"${config:torizon_ip}\" ]] && true || false"],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "validate-arch-x86",
      "detail": "hide",
      "command": "bash",
      "type": "process",
      "args": [
        "-c",
        "[[ \"${config:torizon_arch}\" == \"x86_64\" ]] && true || false"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "validate-arch-arm",
      "detail": "hide",
      "command": "bash",
      "type": "process",
      "args": [
        "-c",
        "[[ \"${config:torizon_arch}\" == \"armhf\" ]] && true || false"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "validate-arch-arm64",
      "detail": "hide",
      "command": "bash",
      "type": "process",
      "args": [
        "-c",
        "[[ \"${config:torizon_arch}\" == \"aarch64\" ]] && true || false"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "validate-arch-riscv64",
      "detail": "hide",
      "command": "bash",
      "type": "process",
      "args": [
        "-c",
        "[[ \"${config:torizon_arch}\" == \"riscv64\" ]] && true || false"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "layers",
        "color": "terminal.ansiCyan"
      }
    },
    {
      "label": "wait-debugpy-start-arm64",
      "detail": "hide",
      "command": "sleep",
      "type": "process",
      "args": ["2"],
      "dependsOn": [
        "validate-settings",
        "validate-arch-arm64",
        "apply-torizon-packages",
        "copy-docker-compose",
        "pre-cleanup-arm64",
        "build-debug-arm64",
        "build-container-torizon-debug-arm64",
        "push-container-torizon-debug-arm64",
        "pull-container-torizon-debug-arm64",
        "run-container-torizon-debug-arm64",
        "wait-a-bit",
        "pos-cleanup",
        "deploy-torizon-arm64",
        "start-torizon-debug-arm64"
      ],
      "dependsOrder": "sequence",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    },
    {
      "label": "start-torizon-debug-arm64",
      "detail": "hide",
      "command": "ssh",
      "type": "process",
      "args": [
        "-i",
        "${workspaceFolder}/.conf/id_rsa",
        "-o",
        "UserKnownHostsFile=/dev/null",
        "-o",
        "StrictHostKeyChecking=no",
        "-p",
        "${config:torizon_debug_ssh_port}",
        "torizon@${config:torizon_ip}",
        "/home/torizon/go/bin/dlv exec /home/torizon/main --listen=:2345 --headless=true --log=true --log-output=debugger,debuglineerr,gdbwire,lldbout,rpc --accept-multiclient --api-version=2 > out.log 2> err.log &"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": "$msCompile",
      "icon": {
        "id": "flame",
        "color": "terminal.ansiYellow"
      }
    }
  ],
  "inputs": [
    {
      "id": "dockerLogin",
      "type": "promptString",
      "description": "Container Registry Login"
    },
    {
      "id": "dockerImageRegistry",
      "type": "promptString",
      "description": "Image Registry"
    },
    {
      "id": "dockerImageTag",
      "type": "promptString",
      "description": "Image Tag"
    },
    {
      "id": "dockerImageGpu",
      "type": "promptString",
      "description": "Image GPU"
    },
    {
      "id": "dockerPsswd",
      "type": "promptString",
      "password": true,
      "description": "Container Registry Password"
    },
    {
      "id": "archList",
      "type": "pickString",
      "description": "Container architecture",
      "options": ["arm", "arm64"]
    }
  ]
}
